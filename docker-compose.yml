version: '3.8'

services:
  db:
      container_name: db
      image: fegrus/quiz-db
      ports:
        - "3000:3306"
      environment:
        "MYSQL_DB": "myquizappdb"
        "MYSQL_USER": "user"
        "MYSQL_PASSWORD": "password"
      volumes:
        - ./mysql:/var/lib/mysql
  sb-server:
    container_name: sb-server
    image: fegrus/quiz-sb-server
    depends_on:
      - db
    restart: on-failure
    ports:
      - "8081:8080"
    environment:
      "DB_URL": "db"
      "MYSQL_DB": "myquizappdb"
      "MYSQL_USER": "user"
      "MYSQL_PASSWORD": "password"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sb-server.rule=Host(`localhost`)"
      - "traefik.http.routers.sb-server.entrypoints=web-secure"
      - "traefik.http.routers.sb-server.tls=true"
      - "traefik.http.middlewares.test-auth.forwardauth.address=https://example.com/auth"
    profiles: [sb-server, all]
  db_keycloak:
    container_name: db_keycloak
    image: mysql:8.4.0
    platform: linux/amd64
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: "root"
      MYSQL_DATABASE: "keycloak"
      MYSQL_USER: "user"
      MYSQL_PASSWORD: "password"
    volumes:
      - type: bind
        source: ./mysql_keycloak
        target: /var/lib/mysql
  traefik:
    image: traefik:v3.0
    container_name: "traefik"
    command:
      - "--log.level=DEBUG"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web-secure.address=:443"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    labels:
      #### set core configs
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=(PathPrefix(`/traefik`) || HeadersRegexp(`Referer`, `.*/traefik/.*`))"
      #### set traefik dashboard
      - "traefik.http.routers.traefik.service=api@internal"
      #### set middlewares: stripprefix for dashboard
      - "traefik.http.routers.traefik.middlewares=mystrip"
      - "traefik.http.middlewares.mystrip.stripprefix.prefixes=/traefik"
    profiles: [traefik, all]
  keycloak:
    image: quay.io/keycloak/keycloak:25.0.0
    ports:
      - "8080:8080"
    environment:
      KC_DB: mysql
      KC_DB_URL_HOST: db_keycloak
      KC_DB_URL_DATABASE: keycloak
      #KC_DB: keycloak_db
      KC_DB_USERNAME: root
      KC_DB_PASSWORD: root
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_HOSTNAME: myquizapp-keycloak-auth
      KEYCLOAK_ADMIN_PASSWORD: admin
    depends_on:
      - db_keycloak
    command:
      - start-dev
  auth-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest-amd64
    environment:
      - OAUTH2_PROXY_PROVIDER=keycloak-oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL=http://keycloak:8080/realms/quiz-realm
      - OAUTH2_PROXY_CLIENT_ID=oauth2-proxy
      - OAUTH2_PROXY_CLIENT_SECRET="PNO6zfHReeeG9BQWPP5zUqyglz5zrNiM"
      - OAUTH2_PROXY_COOKIE_SECRET="testTesttestTe"
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_REVERSE_PROXY=true
      - OAUTH2_PROXY_REDIRECT_URL=http://localhost:8088/oauth2/callback
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL=true # don't fail if an email address in an id_token is not verified
      - OAUTH2_PROXY_UPSTREAM=http://localhost
      - OAUTH2_PROXY_HTTP_ADDRESS=http://0.0.0.0:4180
      - OAUTH2_PROXY_CODE_CHALLENGE_METHOD=S256
      # - OAUTH2_PROXY_ALLOWED_ROLES='superadmin'
      - OAUTH2_PROXY_SET_AUTHORIZATION_HEADER=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      # For traefik
      # (WARNING: this may contain sensitive information - do not use in production)
      - OUATH2_PROXY_SHOW_DEBUG_ON_ERROR=true
    command:
      - --http-address=0.0.0.0:4180
      - --upstream=http://score-service
      # - --skip-provider-button=true
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.oauth2-proxy.loadbalancer.server.port=4180"
      - "traefik.http.routers.oauth2-proxy.entrypoints=web-secure"
      - "traefik.http.middlewares.oauth2-proxy.forwardauth.address=http://oauth2-proxy:4180"
      - "traefik.http.middlewares.oauth2-proxy.forwardauth.authResponseHeaders=Authorization"
      - "traefik.http.middlewares.oauth2-proxy.forwardauth.trustForwardHeader=true"
      - "traefik.http.routers.oauth2-proxy.rule=PathPrefix(`/oauth2`)"

  score-service:
    image: fegrus/scoreservice
    restart: on-failure
    ports:
      - "8090:8090"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.score-service.rule=Host(`localhost/me`)"
      - "traefik.http.routers.score-service.entrypoints=web-secure"
      - "traefik.http.routers.score-service.tls=true"
      - "traefik.http.middlewares.test-auth.forwardauth.address=http://auth-proxy/auth"
volumes:
  mysql:
  mysql_keycloak:
networks:
  mynetwork:
    driver: bridge

